第一步：生成需求方案文档

    创建一个 Markdown 格式的需求方案文档
    文档中必须使用 Mermaid 图表（可配合 VSCode 的 “Markdown Preview Mermaid Support” 插件预览）
    文档内容应包含：
        功能列表和功能描述
        用例图（Use Case Diagram）
        用户故事（User Stories）
        业务流程图（使用 Mermaid flowchart 或 sequence diagram）
    重要：尽量减少代码示例，专注于需求描述和流程设计

第二步：人工审核与迭代讨论

    生成初稿后，我会进行人工审核
    在这个阶段，请从以下两个角度反复思考和优化方案：
        产品经理视角：关注用户需求、业务价值、功能完整性
        工程师视角：关注技术可行性、实现复杂度、潜在风险
    这个步骤可能会跨越多个会话，每次讨论后请根据反馈修改方案
    注意：如果使用 sub-agent 进行多角度讨论，响应时间会较慢，请提前告知

第三步：敲定技术框架方案

    根据最终确定的需求方案，设计技术框架
    核心原则：
        遵循 KISS 原则（Keep It Simple, Stupid）
        遵循轻量化原则，避免过度设计
        不引入不必要的技术栈和依赖
    输出一份简洁的技术框架方案文档（Markdown 格式）

第四步：生成约束与规范文档

生成两份关键文档：
4.1 红线文档（Constraints Document）

    明确规定项目禁止做的事情，例如：
        禁止的技术选型
        禁止的架构模式
        禁止的代码实践
        安全红线
        性能红线

4.2 规范文档（Standards Document）

    明确规定项目应该遵循的规范，例如：
        代码风格规范
        命名约定
        目录结构规范
        Git 提交规范
        文档编写规范

第五步：生成实施文档

    综合以下四份文档生成详细的实施文档：
        需求方案
        技术框架方案
        红线文档
        规范文档
    注意：由于需要参考多份文档，可能会导致上下文不足，请在生成后进行多轮审核和打磨
    建议使用多个 sub-agent 分别审核不同部分，以减少单次上下文消耗

第六步：任务拆解

将实施文档拆解为：
6.1 总任务文档（Master Plan）

    单独一个 Markdown 文档
    包含项目整体目标、里程碑、关键交付物

6.2 阶段任务文档（Stage Plans）

    每个阶段一个独立的 Markdown 文档
    每个文档包含：
        阶段目标
        具体任务列表
        依赖关系
        验收标准
    使用 sub-agent 并行处理多个阶段文档的生成
    完成后进行人工审核，添加批注
    用红线文档和规范文档对每个阶段文档进行最终校验

第七步：执行各阶段任务

    按阶段顺序执行任务
    每个阶段执行时，必须同时参考：
        红线文档
        规范文档
        总任务文档
        当前阶段任务文档
    配合自主调试工具（如浏览器 MCP、测试工具等）进行验证

第八步：测试覆盖（如果框架支持）

    生成测试用例文档（Test Case Document）
    为每个功能模块编写单元测试
    逐个执行并确保测试通过

——

本次主题：新增“OnHit 聚合接口与伤害桶（Damage Buckets）”方案

文档产出已分组存放于 `docs/damage-buckets/`，按上述步骤对应如下：

- 01 需求方案：`docs/damage-buckets/01-requirements.md`
- 02 技术框架：`docs/damage-buckets/02-architecture.md`
- 03 红线文档：`docs/damage-buckets/03-constraints.md`
- 04 规范文档：`docs/damage-buckets/04-standards.md`
- 05 实施文档：`docs/damage-buckets/05-implementation.md`
- 06 总任务：`docs/damage-buckets/06-master-plan.md`
- 06 阶段任务（样例）：
  - `docs/damage-buckets/06-stage-1.md`
  - `docs/damage-buckets/06-stage-2.md`
- 08 测试用例：`docs/damage-buckets/08-test-cases.md`

说明：本轮仅产出"聚合接口与桶"的方案，不包含具体器官/行为的迁移实现，迁移留待重构阶段按需推进。

---

## 项目二：剑脉蛊（Jianmai Gu）视觉与音频特效

> **创建日期**: 2025-11-09
> **优先级**: 中
> **预期周期**: 3-5 天

### 项目目标

增强剑脉蛊（Jianmai Gu）的玩家感知体验，通过视觉粒子效果和音频反馈，让玩家能够清晰地感受到被动和主动效果。

### 核心需求

#### 被动效果（飞剑脉络）
- 视觉：每隔 1m 显示一个微弱粒子，形成能量脉络
- 音效：10 秒一次心跳声，音量很小

#### 主动效果（雷电信标）
- 视觉：类似于雷电，信标的强连接，连接所有飞剑
- 音效：激活信标/雷电激活的声音

### 文档位置

当前已产出的文档：
- **需求与设计**: `docs/JIANMAI_VISUAL_AUDIO_EFFECTS.md`
  - 包含完整的需求分析
  - 视觉设计规范
  - 音频设计规范
  - 技术实现方案
  - 开发步骤（5 个阶段）
  - 验收标准

### 开发阶段规划

1. **阶段 1**: 被动脉络效果（1-2 天）
   - 创建 JianmaiVisualEffects 类
   - 实现能量线和粒子效果

2. **阶段 2**: 被动心跳音效（0.5 天）
   - 创建 JianmaiAudioEffects 类
   - 集成音效资源

3. **阶段 3**: 主动雷电效果（1-2 天）
   - 实现雷电链绘制
   - 集成到 applyActiveBuff()

4. **阶段 4**: 主动激活音效（0.5 天）
   - 添加激活音效资源
   - 音效触发逻辑

5. **阶段 5**: 集成测试与优化（1 天）
   - 完整测试
   - 性能优化
   - 参数调优

### 关键参数

**被动效果**:
- 粒子间隔: 1 米
- 最大粒子数: 50 个
- 脉络透明度: 0.5
- 心跳间隔: 10 秒
- 心跳音量: 0.3

**主动效果**:
- 雷电持续时间: 3 秒
- 粒子生成间隔: 0.3 秒
- 激活音量: 1.0

### 相关文档

- [剑脉蛊主动技能开发指南](./JIANMAI_ACTIVE_SKILL_GUIDE.md)
- [完整特效需求与设计](./JIANMAI_VISUAL_AUDIO_EFFECTS.md)
