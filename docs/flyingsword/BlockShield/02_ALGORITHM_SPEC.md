# æŠ¤å¹•ç³»ç»Ÿ - ç®—æ³•ä¸æ•°å­¦è§„èŒƒ

---

## ğŸ“ æ ¸å¿ƒæ¦‚å¿µ

### ç¬¦å·çº¦å®š

| ç¬¦å· | å«ä¹‰ | å•ä½ |
|------|------|------|
| **P** | ä½ç½®å‘é‡ | ç±³ |
| **P\*** | æ‹¦æˆªç‚¹ï¼ˆé¢„è®¡å‘½ä¸­è½¨è¿¹ä¸Šçš„ç‚¹ï¼‰ | ç±³ |
| **v** | é€Ÿåº¦å‘é‡ | m/s |
| **a** | åŠ é€Ÿåº¦ | m/sÂ² |
| **t** | æ—¶åˆ» | ç§’ |
| **N** | æŠ¤å¹•é£å‰‘æ•°é‡ | ä¸ª |
| **r** | ç¯ç»•åŠå¾„ | ç±³ |
| **R** | ç»éªŒè¡°å‡ç³»æ•° | [0, 0.6] |

---

## 1ï¸âƒ£ æŠ¤å¹•ç”Ÿæˆä¸ç»´æŒ

### 1.1 æŠ¤å¹•æ•°é‡è®¡ç®—

**å…¬å¼**:
```
Trail = é“ç—•ç­‰çº§ (æ•´æ•°)
Exp   = æµæ´¾ç»éªŒ (æ•´æ•°)

N = clamp(
    1 + floor(sqrt(Trail/100)) + floor(Exp/1000),
    1,
    4  // ä¸Šé™
)
```

**ä¾‹å­**:
```
Trail=0,   Exp=0    â†’ N = 1
Trail=100, Exp=0    â†’ N = 1 + 1 + 0 = 2
Trail=100, Exp=1000 â†’ N = 1 + 1 + 1 = 3
Trail=400, Exp=2000 â†’ N = 1 + 2 + 2 = 4
Trail=400, Exp=3000 â†’ N = min(4, 1+2+3) = 4
```

### 1.2 ç¯ç»•åŠå¾„è®¡ç®—

**å…¬å¼**:
```
r_orbit = 2.6 + 0.4 * N
```

**ä¾‹å­**:
```
N=1 â†’ r = 2.6 + 0.4 = 3.0  m
N=2 â†’ r = 2.6 + 0.8 = 3.4  m
N=3 â†’ r = 2.6 + 1.2 = 3.8  m
N=4 â†’ r = 2.6 + 1.6 = 4.2  m
```

### 1.3 åˆå§‹è€ä¹…è®¡ç®—

**å…¬å¼**:
```
Durâ‚€ = 60 + 0.3 * Trail + 0.1 * Exp
```

**ä¾‹å­**:
```
Trail=100, Exp=1000 â†’ Durâ‚€ = 60 + 30 + 100 = 190
Trail=300, Exp=2000 â†’ Durâ‚€ = 60 + 90 + 200 = 350
```

---

## 2ï¸âƒ£ é€Ÿåº¦ä¸ååº”å»¶è¿Ÿ

### 2.1 æœ€å¤§é€Ÿåº¦

**å…¬å¼**:
```
vMax = 6.0 + 0.02 * Trail + 0.001 * Exp
```

**ä¾‹å­**:
```
Trail=0,   Exp=0    â†’ vMax = 6.0     m/s
Trail=100, Exp=1000 â†’ vMax = 6.0 + 2 + 1 = 9.0 m/s
Trail=200, Exp=3000 â†’ vMax = 6.0 + 4 + 3 = 13.0 m/s
```

### 2.2 åŠ é€Ÿåº¦

**å…¬å¼** (å»ºè®®å¸¸æ•°):
```
aMax = 40.0  // m/sÂ²ï¼ˆå¯é…ç½®ï¼‰
```

### 2.3 ååº”å»¶è¿Ÿ

**å…¬å¼**:
```
reaction = clamp(
    0.06 - 0.00005 * Exp,
    0.02,      // ä¸‹é™
    0.06       // ä¸Šé™
)
```

**å«ä¹‰**: æŠ¤å¹•é£å‰‘ä»äº‹ä»¶å‘ç”Ÿåˆ°å¼€å§‹åŠ é€Ÿçš„å»¶è¿Ÿã€‚

**ä¾‹å­**:
```
Exp=0    â†’ reaction = 0.06 - 0 = 0.06 s
Exp=400  â†’ reaction = 0.06 - 0.02 = 0.04 s
Exp=1200 â†’ reaction = clamp(0.06 - 0.06, 0.02, 0.06) = 0.02 s
Expâ‰¥1200 â†’ reaction = 0.02 s (ä¸‹é™)
```

---

## 3ï¸âƒ£ æ‹¦æˆªè§„åˆ’

### 3.1 å¨èƒç±»å‹åˆ¤å®š

**æŠ•å°„ç‰© (Projectile)**:
- å­˜åœ¨æŠ•å°„ä½“ä½ç½® `projPos` ä¸é€Ÿåº¦ `projVel`
- åŒ…æ‹¬ï¼šç®­çŸ¢ã€ç«çƒã€é›ªçƒç­‰

**è¿‘æˆ˜ (Melee)**:
- æ— æŠ•å°„ä½“ä¿¡æ¯
- æ”»å‡»è€…ç›´æ¥å†²å‘ç›®æ ‡

### 3.2 æŠ•å°„ç‰©å‘½ä¸­ç‚¹é¢„æµ‹

**æ­¥éª¤**:

1. **åˆå§‹æ¡ä»¶**:
   - æŠ•å°„ç‰©ä½ç½®ï¼š`Pâ‚€ = projPos`
   - æŠ•å°„ç‰©é€Ÿåº¦ï¼š`vâ‚€ = projVel`
   - é‡åŠ›åŠ é€Ÿåº¦ï¼š`g = 9.8 * 0.05 = 0.49` (Minecraft å•ä½)
   - ç›®æ ‡ AABBï¼š`target.getBoundingBox()`

2. **è¿­ä»£é¢„æµ‹** (0 åˆ° 1.0 ç§’ï¼Œæ­¥é•¿ 0.05 ç§’):
   ```
   for t in [0.0, 0.05, 0.1, 0.15, ..., 1.0]:
       P(t) = Pâ‚€ + vâ‚€*t + 0.5*g*tÂ²  // äºŒæ¬¡è½¨è¿¹

       if P(t) ä¸ AABB ç›¸äº¤:
           return (P(t), t)  // å‘½ä¸­ç‚¹ä¸æ—¶åˆ»

   return null  // æ— å‘½ä¸­
   ```

3. **æ‹¦æˆªç‚¹è®¡ç®—**:
   ```
   I = å‘½ä¸­ç‚¹
   P* = I - 0.3 * normalize(vâ‚€)  // æå‰ 0.3m
   ```
   **å«ä¹‰**: é£å‰‘åº”åœ¨æŠ•å°„ç‰©åˆ°è¾¾å‰ 0.3m å¤„å¾…å‘½ã€‚

### 3.3 è¿‘æˆ˜å‘½ä¸­ç‚¹é¢„æµ‹

**æ­¥éª¤**:

1. **æ”»å‡»çº¿æ®µæ„é€ **:
   ```
   attacker_pos = attacker.getPos()
   target_pos = target.getPos()

   // çº¿æ®µï¼šä»æ”»å‡»è€…æŒ‡å‘ç›®æ ‡
   segment = Line(attacker_pos, target_pos)
   ```

2. **æœ€è¿‘ç‚¹è®¡ç®—**:
   ```
   target_aabb = target.getBoundingBox()
   I = segment.closestPointTo(target_aabb)
   ```

3. **æ‹¦æˆªç‚¹**:
   ```
   P* = I  // æˆ– I + 0.3*normalize(target_pos - attacker_pos)
   ```

### 3.4 å¯è¾¾æ€§åˆ¤å®š

**æ—¶é—´çª—å£**:
```
tReach = max(reaction_delay, distance(S_pos, P*) / vMax)

å¯è¾¾ âŸº windowMin â‰¤ tReach â‰¤ windowMax
      âŸº 0.1 â‰¤ tReach â‰¤ 1.0
```

**å«ä¹‰**: é£å‰‘å¿…é¡»åœ¨ 0.1~1.0 ç§’å†…åˆ°è¾¾æ‹¦æˆªç‚¹ï¼Œæ‰è§†ä¸ºå¯æ‹¦æˆªã€‚

**ä¾‹å­**:
```
distance = 5m, vMax = 10m/s, reaction = 0.06s

tReach = max(0.06, 5/10) = 0.5s
0.1 â‰¤ 0.5 â‰¤ 1.0 â†’ âœ… å¯æ‹¦æˆª
```

### 3.5 æ‹¦æˆªæŸ¥è¯¢ç”Ÿæˆ

**è¾“å‡ºç»“æ„**:
```java
record InterceptQuery(
    Vec3 interceptPoint,    // P* æ‹¦æˆªç‚¹
    double tImpact,         // æŠ•å°„ç‰©åˆ°è¾¾ P* çš„æ—¶åˆ»ï¼ˆç§’ï¼‰
    IncomingThreat threat   // åŸå§‹å¨èƒ
)
```

---

## 4ï¸âƒ£ ä»²è£ä¸ä»¤ç‰Œåˆ†é…

### 4.1 é—®é¢˜èƒŒæ™¯

åŒä¸€å¸§å†…ï¼Œå¤šä¸ªå¨èƒå¯èƒ½åŒæ—¶åˆ°è¾¾ï¼Œå¤šä¸ªæŠ¤å¹•é£å‰‘å¯èƒ½åŒæ—¶æ»¡è¶³æ—¶é—´çª—ã€‚ä¸ºé¿å…èµ„æºæµªè´¹å’Œå¤šé‡æ‹¦æˆªï¼Œéœ€è¦ç¡®ä¿**åŒå¸§ä»…ä¸€æŠŠé£å‰‘**æ‰§è¡Œæ‹¦æˆªã€‚

### 4.2 ä»²è£ç®—æ³•

**æ­¥éª¤**:

1. **é‡‡é›†æ‰€æœ‰æŠ¤å¹•å€™é€‰**:
   ```
   for each wardSword in playerWards:
       if wardSword.getWardState() == ORBIT:
           tReach = InterceptPlanner.timeToReach(
               wardSword,
               query.interceptPoint,
               tuning
           )

           if windowMin â‰¤ tReach â‰¤ windowMax:
               candidates.add((wardSword, tReach))
   ```

2. **é€‰æ‹©æœ€å° tReach**:
   ```
   if candidates.isEmpty():
       return null  // æ— é£å‰‘å¯æ‹¦æˆª

   best = candidates.minBy(tReach)
   return best  // ä¸­æ ‡é£å‰‘
   ```

3. **åŸå­æ›´æ–°** (ç¡®ä¿åŒå¸§å”¯ä¸€):
   ```
   // æ–¹å¼ A: å•çº¿ç¨‹ï¼ˆæœåŠ¡ç«¯ï¼‰
   synchronized(wardService) {
       if (interceptToken.isFreeTaken()) {
           interceptToken.claim(best);
           best.setCurrentQuery(query);
           best.setWardState(INTERCEPT);
       }
   }

   // æ–¹å¼ B: é€šé“ (å¯é€‰)
   LinkageChannel("ward-intercept").send(query);
   ```

---

## 5ï¸âƒ£ æ‹¦æˆªæˆåŠŸåˆ¤å®š

### 5.1 åˆ°è¾¾ä¸ç¢°æ’æ£€æµ‹

**æ—¶åº**:
```
t=0     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ t=tReach â”€â”€â”€â”€â”€â”€â”€â”€ t=tImpact
        é£å‰‘å¼€å§‹   é£å‰‘åˆ°è¾¾ P*    æŠ•å°„ç‰©åˆ°è¾¾ I
        ç§»åŠ¨       ï¼ˆåº”åˆ°è¾¾ï¼‰
```

**æˆåŠŸæ¡ä»¶**:
1. é£å‰‘å·²åˆ°è¾¾æ‹¦æˆªç‚¹ P* é™„è¿‘ï¼ˆè¯¯å·® < 0.5mï¼‰
2. æŠ•å°„ç‰©ä»åœ¨æœ‰æ•ˆèŒƒå›´å†…ï¼ˆè· P* < 1.0mï¼‰
3. æ—¶åºæœªå¤±é…ï¼ˆtReach â‰¤ tImpact + 0.2sï¼‰

### 5.2 æˆåŠŸå“åº”

**ä¼¤å®³æ¸…é›¶**:
```
damage_to_player = 0  // å®Œå…¨å¸æ”¶

OR ï¼ˆå¯é€‰ï¼Œç©¿ç”²è§„åˆ™ï¼‰

damage_to_player = original_damage * 0.3  // ä¿ç•™ 30%
```

**è€ä¹…æ¶ˆè€—**:
```
costBlock = round(8 * (1 - R))

where R = clamp(Exp / (Exp + 2000), 0, 0.6)
```

**ä¾‹å­**:
```
Exp=0    â†’ R=0   â†’ costBlock = 8
Exp=1000 â†’ R=0.33 â†’ costBlock = round(8*0.67) = 5
Exp=2000 â†’ R=0.5 â†’ costBlock = 4
Expâ‰¥5000 â†’ R=0.6 â†’ costBlock = round(8*0.4) = 3
```

### 5.3 å¤±è´¥å“åº”

**è§¦å‘æ¡ä»¶**:
- æ—¶é—´çª—å£è¶…æœŸ (tReach > 1.0s)
- é£å‰‘è·¯å¾„é˜»æŒ¡
- å…¶ä»–åŸå› æœªèƒ½åŠæ—¶åˆ°è¾¾

**ä¼¤å®³ä¿ç•™**:
```
damage_to_player = original_damage  // å®Œå…¨ç©¿é€
```

**è€ä¹…æ¶ˆè€—**:
```
costFail = round(2 * (1 - 0.5*R))
```

**ä¾‹å­**:
```
Exp=0    â†’ R=0   â†’ costFail = 2
Exp=2000 â†’ R=0.5 â†’ costFail = round(2*0.75) = 2
Expâ‰¥5000 â†’ R=0.6 â†’ costFail = round(2*0.7) = 1
```

---

## 6ï¸âƒ£ åå‡»ç³»ç»Ÿ

### 6.1 åå‡»æ¡ä»¶

**è·ç¦»æ£€æŸ¥**:
```
è·ç¦» = dist(attacker, owner)

åå‡»è§¦å‘ âŸº è·ç¦» â‰¤ counter_range (5.0m) AND æ‹¦æˆªæˆåŠŸ
```

### 6.2 æŠ•å°„ç‰©åå¼¹

**é•œé¢åå°„å…¬å¼**:
```
n = é£å‰‘è¡¨é¢æ³•å‘é‡ï¼ˆé€šå¸¸æŒ‡å‘æ”»å‡»è€…æ–¹å‘ï¼‰
v_new = v_old - 2*(v_oldÂ·n)*n

// æˆ–ç®€åŒ–ç‰ˆï¼ˆæ²¿åæ–¹å‘ï¼‰
v_new = -v_old  // æ‰å¤´è¿”å›
```

**æ‰€æœ‰æƒæ”¹å˜**:
```
projectile.setOwner(player)
projectile.setDeltaMovement(v_new)
```

### 6.3 è¿‘æˆ˜åå‡»

**ä¼¤å®³è®¡ç®—**:
```
D_counter = 5 + 0.05 * Trail + 0.01 * Exp
```

**ä¾‹å­**:
```
Trail=0,   Exp=0    â†’ D = 5
Trail=100, Exp=1000 â†’ D = 5 + 5 + 10 = 20
Trail=200, Exp=3000 â†’ D = 5 + 10 + 30 = 45
```

**ä¼¤å®³è§¦å‘**:
```
// æ²¿ player â†’ attacker æ–¹å‘ç”Ÿæˆä¼¤å®³äº‹ä»¶
direction = normalize(attacker.pos - player.pos)
applyDamage(attacker, D_counter, direction)
```

### 6.4 åå‡»è€ä¹…æ¶ˆè€—

**å…¬å¼**:
```
costCounter = round(10 * (1 - R))
```

**ä¾‹å­**:
```
Exp=0    â†’ costCounter = 10
Exp=2000 â†’ costCounter = 5
Expâ‰¥5000 â†’ costCounter = 4
```

---

## 7ï¸âƒ£ çŠ¶æ€æœºè½¬æ¢

### 7.1 çŠ¶æ€å›¾

```
                    onIncomingThreat
                    (æ‹¦æˆªåˆ†é…)
                          â”‚
                          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                ORBIT                      â”‚
    â”‚  ï¼ˆç¯ç»•ä¸»äººï¼Œä¿æŒè·ç¦» r_orbitï¼‰          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â”‚ (æ‹¦æˆªä»¤ç‰Œ)
                          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚              INTERCEPT                    â”‚
    â”‚  ï¼ˆå‘ P* ç§»åŠ¨ï¼Œæ—¶é—´çª— 0.1~1.0sï¼‰         â”‚
    â”‚  â”œâ”€ æˆåŠŸç¢°æ’ â†’ COUNTER/RETURN           â”‚
    â”‚  â””â”€ è¶…æ—¶æˆ–å¤±è´¥ â†’ RETURN                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚              COUNTER                      â”‚
    â”‚  ï¼ˆæ‰§è¡Œåå‡»ï¼Œä»…è·ç¦» â‰¤ 5m æ—¶è§¦å‘ï¼‰        â”‚
    â”‚  â””â”€ åå‡»å®Œæˆ â†’ RETURN                   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚              RETURN                      â”‚
    â”‚  ï¼ˆè¿”å›ç¯ç»•æ§½ä½ï¼Œè·ç¦» < 0.5mï¼‰           â”‚
    â”‚  â””â”€ åˆ°è¾¾ç¯ç»•ä½ â†’ ORBIT                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 è¶…æ—¶æ£€æµ‹

**è§„åˆ™**:
```
elapsed = (worldTime - interceptStartTime) / 20  // tick è½¬ç§’

if elapsed > windowMax (1.0s):
    setWardState(RETURN)
    consumeWardDurability(costFail)
```

---

## 8ï¸âƒ£ ç»éªŒè¡°å‡å‚æ•°

### 8.1 è¡°å‡ç³»æ•°è®¡ç®—

**å…¬å¼**:
```
R = clamp(Exp / (Exp + 2000), 0, 0.6)
```

**å«ä¹‰**: ç»éªŒè¶Šå¤šï¼ŒR è¶Šå¤§ï¼Œæ¶ˆè€—è¶Šä½ã€‚

### 8.2 æ¶ˆè€—å‡½æ•°

| æ¶ˆè€—ç±»å‹ | å…¬å¼ | R=0 | R=0.3 | R=0.6 |
|---------|------|-----|-------|-------|
| **Block** | 8 * (1-R) | 8 | 6 | 3 |
| **Counter** | 10 * (1-R) | 10 | 7 | 4 |
| **Fail** | 2 * (1-0.5R) | 2 | 2 | 1 |

---

## 9ï¸âƒ£ æ€§èƒ½ä¼˜åŒ–

### 9.1 è®¡ç®—ç¼“å­˜

**å»ºè®®**:
```
// ç¼“å­˜è®¡ç®—ç»“æœï¼Œé¿å…é‡å¤
cachedPlan = InterceptPlanner.plan(threat, owner, tuning)
cachedTReach = InterceptPlanner.timeToReach(sword, P*, tuning)

// æœ‰æ•ˆæœŸï¼šæœ¬å¸§æˆ–æœ¬äº‹ä»¶å‘¨æœŸ
```

### 9.2 è½¨è¿¹é¢„æµ‹ç²¾åº¦

**æŠ˜ä¸­**:
```
// å¿«é€Ÿé¢„æµ‹ï¼ˆ5 ä¸ªæ ·ç‚¹ï¼Œç²—ç³™ï¼‰
steps = 5, deltaT = 0.2s

// ç²¾ç¡®é¢„æµ‹ï¼ˆ20 ä¸ªæ ·ç‚¹ï¼Œç²¾ç»†ï¼‰
steps = 20, deltaT = 0.05s
```

---

## ğŸ”Ÿ æ•°å€¼éªŒè¯æ¸…å•

- [ ] æŠ¤å¹•æ•°é‡å…¬å¼ï¼šN âˆˆ [1, 4]
- [ ] ç¯ç»•åŠå¾„ï¼šr âˆˆ [3.0, 4.2] m
- [ ] æœ€å¤§é€Ÿåº¦ï¼švMax âˆˆ [6.0, âˆ)
- [ ] æ—¶é—´çª—ï¼š[0.1, 1.0] s
- [ ] è€ä¹…æ¶ˆè€—ï¼šcostBlock â‰¥ costFail
- [ ] ç»éªŒè¡°å‡ï¼šR âˆˆ [0, 0.6]
- [ ] åå‡»è·ç¦»ï¼š5.0 m
- [ ] ååº”å»¶è¿Ÿï¼š[0.02, 0.06] s

---

**è§„èŒƒç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025å¹´

