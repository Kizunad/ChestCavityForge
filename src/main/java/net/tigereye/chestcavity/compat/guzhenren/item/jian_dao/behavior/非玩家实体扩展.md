# 剑道器官「非玩家实体扩展」说明（参考：蕴剑青莲蛊）

目标：为非玩家生物（`Mob`/任意 `LivingEntity`）启用与玩家一致的器官行为与主动技能激活路径，确保“装备器官 → 自动参与战斗/施放能力”。本文以“蕴剑青莲蛊”为参考模板，给出可复用的接入模式。

---

## 设计原则
- 统一激活链路：使用 `ActiveSkillOps.activateFor(LivingEntity, id)` 分流玩家/非玩家触发路径，避免直接依赖 `ServerPlayer`。
  - 入口：`compat/guzhenren/util/behavior/ActiveSkillOps.java:32`
- 行为注册规范：在行为类 `enum` 的 `static {}` 中完成 `OrganActivationListeners.register(...)`，禁止构造器注册，避免早期类加载问题。
  - 参考：`.../YunJianQingLianGuOrganBehavior.java:79`
- 仅玩家承担资源与提示：非玩家触发保持“静默”，默认不做真元/精力等资源消耗与聊天提示，减少性能与依赖。
- 状态入 `OrganState`：所有跨 tick 状态（激活标记、AI Goal 快照、延迟关闭时间戳、领域UUID等）集中写入器官 NBT，支持区块卸载/重载后的延续。
- 观察而不侵入：通过 `AIIntrospection` 读取 `Mob` 当前正在运行的攻击/仇恨 Goal，作为“进入/退出战斗”的判据；不修改其原生 AI。
  - 入口：`compat/guzhenren/util/behavior/AIIntrospection.java:72`

---

## 非玩家自动化（状态机）
以“蕴剑青莲蛊”的实现为例，行为类在 `onSlowTick` 中对 `Mob` 分支调用 `handleNonPlayerAutomation(...)`：
- 位置：`.../behavior/organ/YunJianQingLianGuOrganBehavior.java:406`

状态机要点：
- 进入战斗：当检测到攻击 Goal 运行或存在有效 `target`，若未激活则调用 `ActiveSkillOps.activateFor(mob, ABILITY_ID)` 以“切换开启”。
- 持续战斗：若已激活且仍有目标，持续下发“攻击该目标”的集群指令（如青莲剑群）。
- 脱战延迟关闭：脱战记录 `DisengagedAt`（worldTime）；超过延迟阈值（默认 5s/100tick）再次调用 `activateFor` 切换“关闭”。
- Goal 快照：将 `当前攻击Goal类名列表` 写入 `OrganState`，仅在发生变更时触发动作，降低抖动。

涉及关键字段（器官 NBT/OrganState）：
- `Active`：是否激活
- `LastAttackGoals`：上次 tick 的攻击 Goal 列表（字符串数组）
- `DisengagedAt`：脱战起始时间戳（worldTime）
- `DomainIdMost/Least`：青莲剑域 UUID（64+64 位）
- 参考定义：`.../YunJianQingLianGuOrganBehavior.java:392` 起

---

## 接入步骤（为任意剑道器官启用非玩家支持）
1) 能力注册
- 在器官行为 `enum` 的 `static {}` 中：
  - `OrganActivationListeners.register(ABILITY_ID, Behavior::activateAbility);`
  - 避免在构造器或客户端早期阶段注册。

2) 统一触发入口
- 所有“主动技能入口”保持签名 `(LivingEntity entity, ChestCavityInstance cc)`，内部第一行强制判定 `ServerLevel`，统一通过 `findMatchingOrgan(cc)` 获取对应器官 `ItemStack`。

3) onSlowTick 分流
- 玩家：维持原有资源扣除/提示逻辑（推荐用 `ResourceOps` 等助手）。
- 非玩家：调用 `handleNonPlayerAutomation(mob, level, cc, organ)`，按“进入/持续/脱战”状态机实施自动开启/关闭与目标更新；不要做资源结算与客户端提示。

4) 状态持久化
- 使用 `OrganState.of(organ, "<BehaviorName>")` 写入上述字段；避免使用实体数据组件直接挂载在 `Mob` 上，以防止热插拔/器官迁移造成的残留状态。

5) 目标与联动（可选）
- 若器官有召唤物/领域（如青莲剑域）：在激活时保存 UUID；在关闭时显式注销并清理召唤物。
- 若需要“命令召唤物攻击”：在持续战斗分支中读取领域/管理器对象，派发 `commandAttack(target)` 或等价 API。

---

## 代码片段（模板）
以下片段摘自“蕴剑青莲蛊”，可直接复用：

激活注册：
```
static {
  OrganActivationListeners.register(ABILITY_ID, Behavior::activateAbility);
}
```

统一触发（非玩家静默）：
```
boolean ok = ActiveSkillOps.activateFor(owner, ABILITY_ID);
```

AI 观察与状态机触发（要点）：
```
List<String> running = AIIntrospection.getRunningAttackGoalNames(mob);
boolean hasTarget = mob.getTarget() != null && mob.getTarget().isAlive() && !mob.getTarget().isAlliedTo(mob);
boolean isAttacking = !running.isEmpty() || hasTarget;

if (!active && isAttacking) {
  ActiveSkillOps.activateFor(mob, ABILITY_ID); // 开启
  state.setLong("DisengagedAt", 0L);
} else if (active && !isAttacking) {
  long t = state.getLong("DisengagedAt", 0L);
  if (t == 0L) state.setLong("DisengagedAt", now);
  else if (now - t >= 100) ActiveSkillOps.activateFor(mob, ABILITY_ID); // 关闭
}

// 覆盖上次 Goal 快照
ListTag tag = new ListTag();
for (String name : running) tag.add(StringTag.valueOf(name));
state.setList("LastAttackGoals", tag);
```

---

## 注意事项
- 行为类内涉及“玩家专属”的提示与资源结算，必须放在 `instanceof ServerPlayer` 分支内，避免对 `Mob` 抛空指针或误提示。
- 不要在非玩家路径中直接消耗 `ResourceOps` 资源（默认无 UI/反馈，且多数 `Mob` 不含相关资源）；如确有平衡需要，请在特定 `Mob` 类型上单独实现。
- 关闭路径务必“完整撤销”——移除召唤物、注销领域、清理实体标签，以防内存/逻辑泄漏。
- 尽量保持“静默”策略（无广播/粒子轰炸），避免刷屏与性能波动；必要的可视化仅限召唤物/领域自身。

---

## 测试清单
- 装备/卸下：非玩家装配器官 → 进入/退出战斗 → 自动开启/关闭能力，无残留域/召唤物。
- 目标切换：仇恨目标变化时，召唤物能稳定切换攻击对象。
- 区块卸载/重载：`OrganState` 能正确恢复（激活态、领域 UUID、飞剑列表等）。
- 性能：多只 `Mob` 并发时 tick 平稳，无异常日志；AI 观察仅做对比/快照更新。

---

## 参考文件
- `src/main/java/net/tigereye/chestcavity/compat/guzhenren/item/jian_dao/behavior/organ/YunJianQingLianGuOrganBehavior.java:79`
- `src/main/java/net/tigereye/chestcavity/compat/guzhenren/item/jian_dao/behavior/organ/YunJianQingLianGuOrganBehavior.java:392`
- `src/main/java/net/tigereye/chestcavity/compat/guzhenren/item/jian_dao/behavior/organ/YunJianQingLianGuOrganBehavior.java:406`
- `src/main/java/net/tigereye/chestcavity/compat/guzhenren/util/behavior/ActiveSkillOps.java:32`
- `src/main/java/net/tigereye/chestcavity/compat/guzhenren/util/behavior/AIIntrospection.java:72`

---

## 实施计划（分案）
- A 计划（快速落地：裂剑蛊 + 剑域蛊）
  - `src/main/java/net/tigereye/chestcavity/compat/guzhenren/item/jian_dao/behavior/plans/A-快速落地_裂剑蛊-剑域蛊_非玩家自动化计划.md`
- B 计划（影子与投射抽象：剑影蛊）
  - `src/main/java/net/tigereye/chestcavity/compat/guzhenren/item/jian_dao/behavior/plans/B-影子与投射抽象_剑影蛊_非玩家计划.md`
- C 计划（冥想与领域：剑心蛊）
  - `src/main/java/net/tigereye/chestcavity/compat/guzhenren/item/jian_dao/behavior/plans/C-冥想与领域_剑心蛊_非玩家计划.md`
- D 计划（指挥与护挡：剑引蛊）
  - `src/main/java/net/tigereye/chestcavity/compat/guzhenren/item/jian_dao/behavior/plans/D-指挥与护挡_剑引蛊_非玩家计划.md`
- E 预研（收剑令：剑鞘蛊 NPC）
  - `src/main/java/net/tigereye/chestcavity/compat/guzhenren/item/jian_dao/behavior/plans/E-收剑令_剑鞘蛊_NPC预研计划.md`
