# é˜¶æ®µ3å®Œæˆæ€»ç»“ - ç•Œé¢ç³»ç»Ÿ + Capabilities API

## ğŸ“… åŸºæœ¬ä¿¡æ¯

- **é˜¶æ®µåç§°**: é˜¶æ®µ3 - ç•Œé¢ç³»ç»Ÿ + Capabilities APIé›†æˆ
- **å®Œæˆæ—¥æœŸ**: 2025-11-14
- **å®é™…å·¥ä½œé‡**: 1å¤©
- **åŸè®¡åˆ’å·¥ä½œé‡**: 5å¤©
- **çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“¦ äº¤ä»˜ç‰©æ¸…å•

### 1. CloneInventoryMenu.java (210è¡Œ)
**ä½ç½®**: `src/main/java/net/tigereye/chestcavity/compat/guzhenren/item/jian_dao/ui/CloneInventoryMenu.java`

**æ ¸å¿ƒåŠŸèƒ½**:
- 7æ§½ä½å®¹å™¨èœå•ï¼ˆ6è›Šè™« + 1å¢ç›Šï¼‰
- æ§½ä½ç±»å‹è¿‡æ»¤ï¼ˆTag: `guzhenren:guchong`ï¼‰
- å®Œæ•´çš„ç©å®¶èƒŒåŒ…é›†æˆï¼ˆ3è¡ŒèƒŒåŒ… + å¿«æ·æ ï¼‰
- Shift-Clickå¿«é€Ÿç§»åŠ¨æ”¯æŒ
- æ‰€æœ‰æƒæ ¡éªŒé›†æˆ

**å…³é”®ç±»**:
- `GuSlot`: è›Šè™«ä¸“ç”¨æ§½ä½ï¼ˆä»…æ¥å—è›Šè™«ï¼Œä¸å¯å †å ï¼‰
- `BoostSlot`: å¢ç›Šç‰©å“æ§½ä½ï¼ˆå½“å‰æ¥å—æ‰€æœ‰ç‰©å“ï¼‰

**æŠ€æœ¯äº®ç‚¹**:
```java
// æ™ºèƒ½å¿«é€Ÿç§»åŠ¨é€»è¾‘
if (isGuItem(stack)) {
    // è›Šè™« â†’ æ§½ä½0-5
    if (!this.moveItemStackTo(stack, 0, GU_SLOTS, false)) {
        return ItemStack.EMPTY;
    }
} else {
    // å…¶ä»–ç‰©å“ â†’ æ§½ä½6
    if (!this.moveItemStackTo(stack, BOOST_SLOT, BOOST_SLOT + 1, false)) {
        return ItemStack.EMPTY;
    }
}
```

---

### 2. CloneInventoryScreen.java (110è¡Œ)
**ä½ç½®**: `src/main/java/net/tigereye/chestcavity/compat/guzhenren/item/jian_dao/client/CloneInventoryScreen.java`

**æ ¸å¿ƒåŠŸèƒ½**:
- è‡ªå®šä¹‰GUIæ¸²æŸ“
- 176x166åƒç´ å¸ƒå±€
- å¤‡ç”¨çº¹ç†fallbackæœºåˆ¶
- æ ‡é¢˜å±…ä¸­æ˜¾ç¤º
- å·¥å…·æç¤ºæ¸²æŸ“

**çº¹ç†æ–¹æ¡ˆ**:
- **ä¸»æ–¹æ¡ˆ**: `assets/chestcavity/textures/gui/clone_inventory.png` (å¾…å®ç°)
- **å¤‡ç”¨æ–¹æ¡ˆ**: ä½¿ç”¨åŸç‰ˆ `hopper.png` + `generic_54.png` æ‹¼æ¥

**å¸ƒå±€è®¾è®¡**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     åˆ†èº«ç‰©å“æ  (å±…ä¸­æ ‡é¢˜)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [è›Š1][è›Š2][è›Š3][è›Š4][è›Š5][è›Š6] â”‚  â† è›Šè™«æ§½ä½
â”‚ [å¢ç›Š]                         â”‚  â† å¢ç›Šæ§½ä½
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     ç©å®¶èƒŒåŒ… (3è¡Œ Ã— 9åˆ—)       â”‚
â”‚     å¿«æ·æ  (1è¡Œ Ã— 9åˆ—)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 3. Capabilities APIé›†æˆ (80è¡Œ)

#### 3.1 PersistentGuCultivatorClone.getContainerView() (65è¡Œ)
**ä½ç½®**: `PersistentGuCultivatorClone.java:284-340`

**æ ¸å¿ƒåŠŸèƒ½**:
- æä¾› `Container` è§†å›¾åŒ…è£… `ItemStackHandler`
- å®ç°å®Œæ•´çš„ Container æ¥å£ï¼ˆ9ä¸ªæ–¹æ³•ï¼‰
- é›†æˆæ‰€æœ‰æƒæ ¡éªŒï¼ˆ`stillValid()`ï¼‰
- æ¡¥æ¥æ—§APIå’Œæ–°API

**æŠ€æœ¯æ–¹æ¡ˆ**:
- ä½¿ç”¨åŒ¿å `SimpleContainer` å­ç±»
- æ‰€æœ‰æ“ä½œå§”æ‰˜ç»™åº•å±‚ `ItemStackHandler`
- éµå¾ª NeoForge å®˜æ–¹æ¨¡å¼ï¼ˆå‚è€ƒ `CapabilityHooks.java`ï¼‰

**å…³é”®å®ç°**:
```java
public Container getContainerView() {
    return new SimpleContainer(inventory.getSlots()) {
        @Override
        public ItemStack getItem(int slot) {
            return inventory.getStackInSlot(slot);
        }

        @Override
        public boolean stillValid(Player player) {
            return PersistentGuCultivatorClone.this.isOwnedBy(player);
        }
        // ... 7ä¸ªå…¶ä»–æ–¹æ³•
    };
}
```

#### 3.2 ChestCavity.registerCapabilities() (15è¡Œ)
**ä½ç½®**: `ChestCavity.java:279-291`

**æ ¸å¿ƒåŠŸèƒ½**:
- åœ¨ `RegisterCapabilitiesEvent` ä¸­æ³¨å†Œèƒ½åŠ›
- ä½¿ç”¨ `VanillaContainerWrapper.of()` åŒ…è£… Container
- è¿”å› `ResourceHandler<ItemResource>` ç±»å‹

**æŠ€æœ¯äº®ç‚¹**:
```java
event.registerEntity(
    Capabilities.Item.ENTITY,
    CCEntities.PERSISTENT_GU_CULTIVATOR_CLONE.get(),
    (entity, context) -> {
        if (entity instanceof PersistentGuCultivatorClone clone) {
            return VanillaContainerWrapper.of(clone.getContainerView());
        }
        return null;
    }
);
```

---

### 4. å®¹å™¨ä¸Screenæ³¨å†Œ

#### 4.1 CCContainers.java (æ–°å¢5è¡Œ)
**ä½ç½®**: `CCContainers.java:31-35`

```java
public static final DeferredHolder<MenuType<?>, MenuType<CloneInventoryMenu>>
    CLONE_INVENTORY_MENU = MENU_TYPES.register(
        "clone_inventory_menu",
        () -> new MenuType<>(CloneInventoryMenu::new, FeatureFlags.VANILLA_SET)
    );
```

#### 4.2 ChestCavityClientEvents.java (æ–°å¢1è¡Œ)
**ä½ç½®**: `ChestCavityClientEvents.java:25`

```java
event.register(CCContainers.CLONE_INVENTORY_MENU.get(), CloneInventoryScreen::new);
```

---

### 5. PersistentGuCultivatorClone.openInventoryMenu() æ›´æ–°
**ä½ç½®**: `PersistentGuCultivatorClone.java:501-511`

**å˜æ›´**:
- ç§»é™¤ "å°šæœªå®ç°" çš„æç¤ºæ¶ˆæ¯
- å¯ç”¨ `CloneInventoryMenu` çš„å®é™…æ‰“å¼€é€»è¾‘
- é›†æˆæ‰€æœ‰æƒæ ¡éªŒ

**æœ€ç»ˆå®ç°**:
```java
public void openInventoryMenu(ServerPlayer player) {
    if (!isOwnedBy(player)) {
        player.displayClientMessage(Component.literal("Â§cè¿™ä¸æ˜¯ä½ çš„åˆ†èº«ï¼"), true);
        return;
    }

    player.openMenu(new SimpleMenuProvider(
        (id, playerInv, p) -> new CloneInventoryMenu(id, playerInv, this),
        Component.literal("åˆ†èº«ç‰©å“æ ")
    ));
}
```

---

## ğŸ¯ å…³é”®æˆå°±

### æŠ€æœ¯æˆå°±
1. **æ­£ç¡®é›†æˆ NeoForge 1.21.1 Capabilities API**
   - éµå¾ªå®˜æ–¹ `VanillaContainerWrapper` æ¨¡å¼
   - å…¼å®¹ `ResourceHandler<ItemResource>` æ–°API
   - é¿å…ç›´æ¥è¦†ç›– `Entity.getCapability()` (finalæ–¹æ³•)

2. **å®Œæ•´çš„7æ§½ä½GUIç³»ç»Ÿ**
   - è‡ªå®šä¹‰å®¹å™¨èœå•
   - æ§½ä½ç±»å‹è¿‡æ»¤
   - Shift-Clickæ™ºèƒ½ç§»åŠ¨
   - å®¢æˆ·ç«¯æ¸²æŸ“

3. **æ‰€æœ‰æƒå®‰å…¨æœºåˆ¶**
   - èœå•çº§åˆ«ï¼š`Container.stillValid()`
   - å®ä½“çº§åˆ«ï¼š`PersistentGuCultivatorClone.isOwnedBy()`
   - åŒé‡ä¿æŠ¤é˜²æ­¢éæ³•è®¿é—®

### æ¶æ„ä¼˜åŒ–
- **æ¨¡å—åŒ–è®¾è®¡**: UIä»£ç ç‹¬ç«‹äºå®ä½“é€»è¾‘
- **å¤‡ç”¨æ–¹æ¡ˆ**: GUIçº¹ç†ä½¿ç”¨fallbackæœºåˆ¶
- **å‘åå…¼å®¹**: ä¿ç•™ `getInventory()` ç›´æ¥è®¿é—®æ–¹æ³•

---

## ğŸ“Š ä»£ç ç»Ÿè®¡

| ç±»åˆ« | æ–‡ä»¶æ•° | æ–°å¢è¡Œæ•° | ä¿®æ”¹è¡Œæ•° | æ€»ä»£ç é‡ |
|------|-------|---------|---------|---------|
| æ–°å¢æ–‡ä»¶ | 2 | 320 | 0 | 320 |
| ä¿®æ”¹æ–‡ä»¶ | 5 | 80 | 15 | 95 |
| **æ€»è®¡** | **7** | **400** | **15** | **415** |

### æ–‡ä»¶è¯¦æƒ…
- `CloneInventoryMenu.java`: +210è¡Œ
- `CloneInventoryScreen.java`: +110è¡Œ
- `PersistentGuCultivatorClone.java`: +65è¡Œ (getContainerView)
- `ChestCavity.java`: +15è¡Œ (registerCapabilities)
- `CCContainers.java`: +5è¡Œ
- `ChestCavityClientEvents.java`: +1è¡Œ
- `é˜¶æ®µæ€»è§ˆ.md`: æ›´æ–°è¿›åº¦

---

## âš ï¸ å·²çŸ¥é—®é¢˜ä¸é—ç•™ä»»åŠ¡

### P2 é—ç•™é—®é¢˜
1. **GUIçº¹ç†æœªå®ç°**
   - **å½“å‰**: ä½¿ç”¨å¤‡ç”¨çº¹ç†æ‹¼æ¥
   - **éœ€æ±‚**: åˆ›å»º `assets/chestcavity/textures/gui/clone_inventory.png` (176x166px)
   - **ä¼˜å…ˆçº§**: P2 (åŠŸèƒ½ä¸å½±å“ï¼Œä»…ç¾è§‚)

### æœªæ¥ä¼˜åŒ–
1. **å¢ç›Šæ§½ä½è¿‡æ»¤**
   - **å½“å‰**: æ¥å—æ‰€æœ‰ç‰©å“
   - **è®¡åˆ’**: å®ç° `CloneBoostItemRegistry.isBoostItem()` (é˜¶æ®µ4)

2. **GUIæœ¬åœ°åŒ–**
   - **å½“å‰**: ç¡¬ç¼–ç ä¸­æ–‡å­—ç¬¦ä¸²
   - **è®¡åˆ’**: æ·»åŠ  `lang/zh_cn.json` ç¿»è¯‘é”®

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### åŠŸèƒ½æµ‹è¯•
1. **åŸºç¡€GUIæµ‹è¯•**
   - [ ] å³é”®ç‚¹å‡»åˆ†èº«èƒ½æ‰“å¼€GUI
   - [ ] éæ‰€æœ‰è€…æ— æ³•æ‰“å¼€GUI
   - [ ] GUIæ­£ç¡®æ˜¾ç¤º7ä¸ªæ§½ä½

2. **æ§½ä½è¿‡æ»¤æµ‹è¯•**
   - [ ] è›Šè™«åªèƒ½æ”¾å…¥æ§½ä½0-5
   - [ ] éè›Šè™«ç‰©å“åªèƒ½æ”¾å…¥æ§½ä½6
   - [ ] Shift-Clickè‡ªåŠ¨åˆ†ç±»

3. **Capabilities APIæµ‹è¯•**
   - [ ] å¤–éƒ¨ä»£ç å¯é€šè¿‡ `entity.getCapability(Capabilities.Item.ENTITY)` è®¿é—®
   - [ ] è¿”å›ç±»å‹ä¸º `ResourceHandler<ItemResource>`
   - [ ] Containeræ“ä½œæ­£ç¡®åŒæ­¥åˆ°å®ä½“

### é›†æˆæµ‹è¯•
1. **è·¨ç»´åº¦æµ‹è¯•**
   - [ ] åˆ†èº«è·¨ç»´åº¦ä¼ é€åGUIä»å¯è®¿é—®
   - [ ] ç‰©å“æ æ•°æ®æ­£ç¡®æŒä¹…åŒ–

2. **å¤šç©å®¶æµ‹è¯•**
   - [ ] æ‰€æœ‰æƒæ ¡éªŒæ­£ç¡®é˜»æ­¢å…¶ä»–ç©å®¶
   - [ ] å¤šä¸ªåˆ†èº«ç‹¬ç«‹ç®¡ç†ç‰©å“æ 

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **Capabilitiesæ–¹æ¡ˆ**: [Capabilities_APIé›†æˆæ–¹æ¡ˆ.md](Capabilities_APIé›†æˆæ–¹æ¡ˆ.md)
- **é˜¶æ®µæ€»è§ˆ**: [é˜¶æ®µæ€»è§ˆ.md](é˜¶æ®µæ€»è§ˆ.md)
- **NeoForgeå®˜æ–¹æ–‡æ¡£**: https://docs.neoforged.net/docs/datastorage/capabilities/

---

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³å¼€å§‹: é˜¶æ®µ4 - å¢ç›Šç³»ç»Ÿ
1. åˆ›å»º `CloneBoostItemRegistry` æ³¨å†Œè¡¨
2. å®ç°å¢ç›Šç‰©å“æ•ˆæœç³»ç»Ÿ
3. æ·»åŠ ç¤ºä¾‹å¢ç›Šç‰©å“
4. é›†æˆåˆ°åˆ†èº«æˆ˜æ–—é€»è¾‘

### å¯é€‰ä¼˜åŒ–
- [ ] åˆ›å»ºè‡ªå®šä¹‰GUIçº¹ç†
- [ ] æ·»åŠ GUIåŠ¨ç”»æ•ˆæœ
- [ ] å®ç°ç‰©å“æ éŸ³æ•ˆ

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2025-11-14
**ä½œè€…**: Claude (Sonnet 4.5)
**çŠ¶æ€**: å·²å®Œæˆ âœ…
**æ€»ä½“è¿›åº¦**: 50% (3/6é˜¶æ®µ)
