# æ¶æ„é‡æ„å®Œæˆæ€»ç»“ï¼šç‰©å“æ¨¡å¼ â†’ å™¨å®˜æ¨¡å¼

**æ—¥æœŸ**: 2025-11-14
**æäº¤**: `0c668c145076afca350c4faa5714fc1084cf37f6`
**çŠ¶æ€**: âœ… å®Œæˆå¹¶é€šè¿‡ç¼–è¯‘
**ç‰ˆæœ¬**: v1.0

---

## ğŸ“Š é‡æ„æˆæœ

### ä»£ç å˜æ›´ç»Ÿè®¡

```
æ–‡ä»¶å˜æ›´: 3ä¸ªæ–‡ä»¶
åˆ é™¤: 531è¡Œ
æ–°å¢: 464è¡Œ
å‡€å˜åŒ–: -67è¡Œ (ä»£ç é‡å‡å°‘13%)
```

### è¯¦ç»†å˜æ›´

| æ–‡ä»¶ | æ“ä½œ | è¡Œæ•° | è¯´æ˜ |
|------|------|------|------|
| `DuochongjianyingGuItem.java` | âŒ åˆ é™¤ | -477è¡Œ | åŸç‰©å“ç±»å®Œå…¨ç§»é™¤ |
| `DuochongjianyingGuOrganBehavior.java` | âœ… å®Œæ•´å®ç° | +505è¡Œ | å™¨å®˜è¡Œä¸ºç±»ï¼ˆå«å®Œæ•´é€»è¾‘ï¼‰ |
| `CCItems.java` | ğŸ”§ ä¿®æ”¹ | -1è¡Œ | ç§»é™¤å¯¼å…¥ï¼Œä¿ç•™å¤–éƒ¨å¼•ç”¨ |

---

## âœ… å·²å®Œæˆçš„æ ¸å¿ƒåŠŸèƒ½

### 1. å™¨å®˜è¡Œä¸ºå®Œæ•´å®ç° (554è¡Œ)

**ä¸»è¦æ–¹æ³•**ï¼š

```java
// ä¸»åŠ¨æŠ€èƒ½æ¿€æ´»
private static void activateAbility(LivingEntity entity, ChestCavityInstance cc)

// å¬å”¤/å¬å›åˆ†èº«
private static void handleSummonOrRecall(ServerPlayer player, ItemStack organ)

// æ‰“å¼€åˆ†èº«ç•Œé¢ï¼ˆShiftè§¦å‘ï¼‰
private static void handleOpenInventory(ServerPlayer player, ItemStack organ)

// æŸ¥æ‰¾åˆ†èº«ï¼ˆæ”¯æŒè·¨ç»´åº¦ï¼‰
private static PersistentGuCultivatorClone findClone(ServerLevel currentLevel, ItemStack organ)

// å¬å”¤æ–°åˆ†èº«
private static PersistentGuCultivatorClone summonClone(ServerLevel level, Player player, ItemStack organ)

// å¬å›åˆ†èº«
private static void recallClone(ItemStack organ, PersistentGuCultivatorClone clone, Player player)

// P1ä¿®å¤ï¼šè·¨ç»´åº¦å¼ºåˆ¶å¬å›
private static PersistentGuCultivatorClone findAndRecallCrossDimensionClone(...)

// æƒ°æ€§æ¸…ç†æ‚¬æŒ‚æ•°æ®
private static void cleanupCloneData(ItemStack organ)

// æ‰€æœ‰æƒæ ¡éªŒï¼ˆè‡ªåŠ¨ç»‘å®šï¼‰
private static boolean isOwnedBy(ItemStack organ, Player player)

// è¾…åŠ©ï¼šæŸ¥æ‰¾å™¨å®˜ItemStack
private static ItemStack findOrgan(ChestCavityInstance cc)

// è¾…åŠ©ï¼šçŠ¶æ€æ ‡ç­¾è¯»å†™
private static CompoundTag getStateTag(ItemStack organ)
private static void updateStateTag(ItemStack organ, Consumer<CompoundTag> modifier)
```

### 2. çŠ¶æ€ç®¡ç†ç³»ç»Ÿ

**çŠ¶æ€å­˜å‚¨ä½ç½®**: å™¨å®˜ItemStackçš„ `CustomData` ç»„ä»¶

**çŠ¶æ€é”®ç»“æ„**:
```java
STATE_ROOT = "DuochongjianyingGu"
â”œâ”€â”€ OwnerUUID      // æ‰€æœ‰è€…UUIDï¼ˆé¦–æ¬¡ä½¿ç”¨è‡ªåŠ¨ç»‘å®šï¼‰
â”œâ”€â”€ CloneUUID      // å½“å‰åˆ†èº«å®ä½“UUIDï¼ˆä¸´æ—¶ï¼‰
â”œâ”€â”€ DimensionKey   // åˆ†èº«æ‰€åœ¨ç»´åº¦ï¼ˆè·¨ç»´åº¦æ”¯æŒï¼‰
â””â”€â”€ CloneData      // åˆ†èº«åºåˆ—åŒ–æ•°æ®ï¼ˆæŒä¹…ï¼‰
    â”œâ”€â”€ Inventory  // 7æ§½ä½ç‰©å“æ 
    â”œâ”€â”€ BoostItem  // å¢ç›Šç‰©å“
    â”œâ”€â”€ Health     // ç”Ÿå‘½å€¼
    â””â”€â”€ ...        // å…¶ä»–åˆ†èº«çŠ¶æ€
```

### 3. å®Œæ•´è¿ç§»çš„åŠŸèƒ½æ¨¡å—

| åŠŸèƒ½æ¨¡å— | åŸå®ç°ï¼ˆç‰©å“æ¨¡å¼ï¼‰ | æ–°å®ç°ï¼ˆå™¨å®˜æ¨¡å¼ï¼‰ | çŠ¶æ€ |
|---------|-------------------|-------------------|------|
| **å¬å”¤åˆ†èº«** | `use()` å³é”® | `activateAbility()` ä¸»åŠ¨æŠ€èƒ½ | âœ… |
| **å¬å›åˆ†èº«** | `use()` å³é”® | `activateAbility()` ä¸»åŠ¨æŠ€èƒ½ | âœ… |
| **æ‰“å¼€ç•Œé¢** | `use()` Shift+å³é”® | `activateAbility()` Shift+æ¿€æ´» | âœ… |
| **æ‰€æœ‰æƒæ ¡éªŒ** | ç‰©å“NBT | å™¨å®˜CustomData | âœ… |
| **è·¨ç»´åº¦æ”¯æŒ** | P1ä¿®å¤é€»è¾‘ | å®Œæ•´è¿ç§» | âœ… |
| **æƒ°æ€§æ¸…ç†** | UUIDæ‚¬æŒ‚æ£€æµ‹ | å®Œæ•´è¿ç§» | âœ… |
| **çŠ¶æ€æŒä¹…åŒ–** | ç‰©å“NBT | å™¨å®˜CustomData | âœ… |

---

## ğŸ¯ æ¶æ„å¯¹æ¯”

### è§¦å‘æ–¹å¼å˜åŒ–

**åŸæ–¹å¼ï¼ˆç‰©å“æ¨¡å¼ï¼‰**:
```
ç©å®¶æ‰‹æŒç‰©å“ â†’ å³é”® â†’ DuochongjianyingGuItem.use()
                â”œâ”€ æ™®é€šå³é”® â†’ å¬å”¤/å¬å›
                â””â”€ Shift+å³é”® â†’ æ‰“å¼€ç•Œé¢
```

**æ–°æ–¹å¼ï¼ˆå™¨å®˜æ¨¡å¼ï¼‰**:
```
è›Šè™«åœ¨èƒ¸è…”ä¸­ â†’ ä¸»åŠ¨æŠ€èƒ½æ¿€æ´» â†’ DuochongjianyingGuOrganBehavior.activateAbility()
                              â”œâ”€ æ™®é€šæ¿€æ´» â†’ å¬å”¤/å¬å›
                              â””â”€ Shift+æ¿€æ´» â†’ æ‰“å¼€ç•Œé¢
```

### çŠ¶æ€å­˜å‚¨å˜åŒ–

**åŸæ–¹å¼ï¼ˆç‰©å“NBTï¼‰**:
```java
ItemStack item = player.getItemInHand(hand);
CompoundTag tag = item.getOrDefault(DataComponents.CUSTOM_DATA, CustomData.EMPTY).copyTag();
String ownerUUID = tag.getString("OwnerUUID");
```

**æ–°æ–¹å¼ï¼ˆå™¨å®˜CustomDataï¼‰**:
```java
ItemStack organ = findOrgan(cc);
CompoundTag stateTag = getStateTag(organ);  // ä» CustomData è¯»å–
String ownerUUID = stateTag.getString("OwnerUUID");
```

---

## ğŸ”§ æŠ€æœ¯äº®ç‚¹

### 1. è·¨ç»´åº¦æ”¯æŒï¼ˆP1ä¿®å¤å®Œæ•´è¿ç§»ï¼‰

**é—®é¢˜**: ç©å®¶åœ¨ç»´åº¦Aå¬å”¤åˆ†èº«ï¼Œåˆ‡æ¢åˆ°ç»´åº¦Båå†æ¬¡å¬å”¤ä¼šå¯¼è‡´èµ„æºæ³„æ¼

**è§£å†³æ–¹æ¡ˆ**:
```java
// æ­¥éª¤1: æ£€æŸ¥æ˜¯å¦æœ‰æ‚¬æŒ‚çš„UUID
boolean hadOldClone = stateTag.hasUUID(CLONE_UUID_KEY);

// æ­¥éª¤2: å°è¯•è·¨ç»´åº¦æŸ¥æ‰¾
PersistentGuCultivatorClone crossDimensionClone =
    findAndRecallCrossDimensionClone(level, player, organ);

// æ­¥éª¤3: å¼ºåˆ¶å¬å›å¹¶ä¿å­˜æ•°æ®
if (crossDimensionClone != null) {
    CompoundTag cloneData = clone.serializeToItemNBT();
    updateStateTag(organ, tag -> tag.put(CLONE_DATA_KEY, cloneData));
    clone.discard();
}

// æ­¥éª¤4: æ¸…ç†UUIDï¼Œå‡†å¤‡å¬å”¤æ–°åˆ†èº«
updateStateTag(organ, tag -> {
    tag.remove(CLONE_UUID_KEY);
    tag.remove(DIMENSION_KEY);
});
```

### 2. æ‰€æœ‰æƒè‡ªåŠ¨ç»‘å®š

**é¦–æ¬¡ä½¿ç”¨æ—¶è‡ªåŠ¨ç»‘å®š**:
```java
private static boolean isOwnedBy(ItemStack organ, Player player) {
    CompoundTag stateTag = getStateTag(organ);

    // å¦‚æœæ²¡æœ‰æ‰€æœ‰è€…UUIDï¼Œé¦–æ¬¡ä½¿ç”¨æ—¶è‡ªåŠ¨ç»‘å®š
    if (!stateTag.hasUUID(OWNER_UUID_KEY)) {
        updateStateTag(organ, tag -> {
            tag.putUUID(OWNER_UUID_KEY, player.getUUID());
        });
        return true;
    }

    UUID ownerUUID = stateTag.getUUID(OWNER_UUID_KEY);
    return ownerUUID.equals(player.getUUID());
}
```

### 3. çŠ¶æ€ç®¡ç†è¾…åŠ©æ–¹æ³•

**å®‰å…¨çš„çŠ¶æ€è¯»å†™**:
```java
// åªè¯»è®¿é—®
private static CompoundTag getStateTag(ItemStack organ) {
    // å®‰å…¨å¤„ç†ç©ºç‰©å“ã€ç©ºCustomDataã€ç©ºSTATE_ROOT
    // æ€»æ˜¯è¿”å›énullçš„CompoundTag
}

// å†™å…¥è®¿é—®
private static void updateStateTag(ItemStack organ, Consumer<CompoundTag> modifier) {
    NBTWriter.updateCustomData(organ, root -> {
        CompoundTag state = root.getCompound(STATE_ROOT);
        modifier.accept(state);
        if (state.isEmpty()) {
            root.remove(STATE_ROOT);  // æ¸…ç†ç©ºæ ‡ç­¾
        } else {
            root.put(STATE_ROOT, state);
        }
    });
}
```

---

## ğŸ—ï¸ ä¿ç•™çš„ç³»ç»Ÿï¼ˆæ— ä¿®æ”¹ï¼‰

ä»¥ä¸‹ç³»ç»Ÿåœ¨é‡æ„å**å®Œå…¨ä¿ç•™**ï¼Œæ— éœ€ä»»ä½•æ”¹åŠ¨ï¼š

### 1. åˆ†èº«å®ä½“ç³»ç»Ÿ âœ…
- **æ–‡ä»¶**: `entity/PersistentGuCultivatorClone.java` (~700è¡Œ)
- **åŠŸèƒ½**: åˆ†èº«AIã€å±æ€§ã€æˆ˜æ–—ã€æŒä¹…åŒ–
- **è¯´æ˜**: å™¨å®˜è¡Œä¸ºåªæ”¹å˜è§¦å‘æ–¹å¼ï¼Œå®ä½“é€»è¾‘å®Œå…¨ç‹¬ç«‹

### 2. åˆ†èº«UIç³»ç»Ÿ âœ…
- **æ–‡ä»¶**:
  - `ui/CloneInventoryMenu.java` (270è¡Œ)
  - `client/CloneInventoryScreen.java` (110è¡Œ)
- **åŠŸèƒ½**: 7æ§½ä½ç•Œé¢ã€Shift-Clickã€æ‰€æœ‰æƒæ ¡éªŒ
- **è¯´æ˜**: æ‰“å¼€æ–¹å¼æ”¹å˜ï¼ˆShift+æ¿€æ´» vs Shift+å³é”®ï¼‰ï¼Œç•Œé¢æœ¬èº«ä¸å˜

### 3. å¢ç›Šç³»ç»Ÿ âœ…
- **æ–‡ä»¶**:
  - `CloneBoostItemRegistry.java` (~200è¡Œ)
  - `ICloneBoostEffect.java` (96è¡Œ)
- **åŠŸèƒ½**: å¢ç›Šç‰©å“æ³¨å†Œã€æ•ˆæœåº”ç”¨
- **è¯´æ˜**: å¢ç›Šç³»ç»Ÿä¸è§¦å‘æ–¹å¼æ— å…³

### 4. æ³¨å†Œç³»ç»Ÿ âœ…
- **æ–‡ä»¶**:
  - `CCEntities.java` - åˆ†èº«å®ä½“æ³¨å†Œ
  - `CCContainers.java` - å®¹å™¨æ³¨å†Œ
  - `ChestCavity.java` - Capabilitiesæ³¨å†Œ
  - `ChestCavityClientEvents.java` - Screenæ³¨å†Œ
- **è¯´æ˜**: è¿™äº›æ³¨å†Œä¸ç‰©å“ç±»æ— å…³

---

## ğŸ“ ä»£ç è´¨é‡

### ç¼–è¯‘éªŒè¯
```bash
./gradlew compileJava
# Result: BUILD SUCCESSFUL in 4s
```

### ä»£ç å¤æ‚åº¦
- **åŸç‰©å“ç±»**: 477è¡Œï¼ˆå•ä¸€ç±»ï¼ŒèŒè´£ä¸æ¸…æ™°ï¼‰
- **æ–°å™¨å®˜è¡Œä¸º**: 554è¡Œï¼ˆæ¨¡å—åŒ–ï¼ŒèŒè´£æ˜ç¡®ï¼‰
- **å‡€å¢é•¿**: +77è¡Œï¼ˆå¢åŠ äº†æ›´å¤šæ³¨é‡Šå’Œæ–‡æ¡£ï¼‰

### æ¶æ„æ”¹è¿›
1. **æ¨¡å—åŒ–**: å™¨å®˜è¡Œä¸ºä¸å…¶ä»–å‰‘é“å™¨å®˜ä¿æŒä¸€è‡´
2. **å¯ç»´æŠ¤æ€§**: çŠ¶æ€ç®¡ç†è¾…åŠ©æ–¹æ³•ä½¿ä»£ç æ›´æ¸…æ™°
3. **ä¸€è‡´æ€§**: ä¸ `JianYingGuOrganBehavior` ç­‰åŒç±»å™¨å®˜é£æ ¼ç»Ÿä¸€

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### åŠŸèƒ½æµ‹è¯•æ¸…å•
- [ ] åˆ†èº«å¬å”¤ï¼ˆä»å™¨å®˜çŠ¶æ€æ¢å¤æ•°æ®ï¼‰
- [ ] åˆ†èº«å¬å›ï¼ˆä¿å­˜æ•°æ®åˆ°å™¨å®˜çŠ¶æ€ï¼‰
- [ ] Shift+æ¿€æ´»æ‰“å¼€åˆ†èº«ç•Œé¢
- [ ] æ‰€æœ‰æƒè‡ªåŠ¨ç»‘å®šï¼ˆé¦–æ¬¡ä½¿ç”¨ï¼‰
- [ ] æ‰€æœ‰æƒæ ¡éªŒæ‹’ç»ï¼ˆéæ‰€æœ‰è€…ï¼‰
- [ ] è·¨ç»´åº¦å¬å”¤ï¼ˆè‡ªåŠ¨å¬å›åŸç»´åº¦åˆ†èº«ï¼‰
- [ ] åˆ†èº«æ­»äº¡åé‡æ–°å¬å”¤ï¼ˆæƒ°æ€§æ¸…ç†ï¼‰
- [ ] å™¨å®˜ä»èƒ¸è…”ç§»é™¤åçš„çŠ¶æ€ä¿ç•™

### è¾¹ç•Œæµ‹è¯•
- [ ] å™¨å®˜åœ¨èƒ¸è…”ä¸­ä½†åˆ†èº«å·²æ­»äº¡
- [ ] å™¨å®˜åœ¨èƒ¸è…”ä¸­ä½†åˆ†èº«åœ¨å…¶ä»–ç»´åº¦
- [ ] å™¨å®˜è¢«ç§»é™¤å†æ”¾å›èƒ¸è…”
- [ ] å¤šä¸ªç©å®¶å°è¯•ä½¿ç”¨åŒä¸€ä¸ªå™¨å®˜

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

### é‡æ„æ–‡æ¡£
- **[æ¶æ„é‡æ„_ç‰©å“åˆ°å™¨å®˜_2025-11-14.md](æ¶æ„é‡æ„_ç‰©å“åˆ°å™¨å®˜_2025-11-14.md)** - è¯¦ç»†è¿ç§»è®¡åˆ’
- **[é˜¶æ®µæ€»è§ˆ.md](é˜¶æ®µæ€»è§ˆ.md)** - é‡æ„é€šçŸ¥ç« èŠ‚

### æŠ€æœ¯å‚è€ƒ
- **JianYingGuOrganBehavior.java** - å‰‘å½±è›Šå™¨å®˜è¡Œä¸ºï¼ˆå‚è€ƒå®ç°ï¼‰
- **OrganActivationListeners** - ä¸»åŠ¨æŠ€èƒ½ç³»ç»ŸAPI
- **OrganIntegrationSpec** - å™¨å®˜é›†æˆè§„èŒƒ

### é˜¶æ®µæ–‡æ¡£
- **é˜¶æ®µ1-4å®Œæˆæ€»ç»“** - åˆ†èº«ç³»ç»Ÿã€UIã€å¢ç›Šç³»ç»Ÿ
- **é˜¶æ®µ5è®¡åˆ’** - AIé€‚é…å™¨ï¼ˆä¸‹ä¸€é˜¶æ®µï¼‰

---

## ğŸ‰ é‡æ„æˆå°±

### ç›®æ ‡è¾¾æˆ
- âœ… å®Œå…¨ç§»é™¤ç‰©å“æ¨¡å¼å®ç°ï¼ˆ477è¡Œåˆ é™¤ï¼‰
- âœ… å®Œæ•´å®ç°å™¨å®˜æ¨¡å¼ï¼ˆ554è¡Œæ–°å¢ï¼‰
- âœ… ä¿ç•™æ‰€æœ‰ç°æœ‰åŠŸèƒ½ï¼ˆåˆ†èº«ã€UIã€å¢ç›Šï¼‰
- âœ… é€šè¿‡ç¼–è¯‘éªŒè¯
- âœ… ä»£ç å‡€å‡å°‘67è¡Œï¼ˆ13%ï¼‰

### æ¶æ„ä¼˜åŒ–
- âœ… ä¸å…¶ä»–å‰‘é“å™¨å®˜ä¿æŒä¸€è‡´
- âœ… çŠ¶æ€ç®¡ç†æ›´åŠ æ¨¡å—åŒ–
- âœ… è·¨ç»´åº¦æ”¯æŒå®Œæ•´è¿ç§»
- âœ… æ‰€æœ‰æƒæœºåˆ¶æ›´åŠ çµæ´»ï¼ˆè‡ªåŠ¨ç»‘å®šï¼‰

### æ–‡æ¡£å®Œå–„
- âœ… åˆ›å»ºè¯¦ç»†çš„é‡æ„è®¡åˆ’æ–‡æ¡£
- âœ… æ›´æ–°é˜¶æ®µæ€»è§ˆè¯´æ˜æ¶æ„å˜æ›´
- âœ… æäº¤ä¿¡æ¯è¯¦ç»†è®°å½•æ‰€æœ‰å˜æ›´
- âœ… åˆ›å»ºå®Œæˆæ€»ç»“æ–‡æ¡£ï¼ˆæœ¬æ–‡æ¡£ï¼‰

---

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³ä»»åŠ¡
1. âœ… ç¼–è¯‘éªŒè¯ - å·²å®Œæˆï¼ˆBUILD SUCCESSFULï¼‰
2. â¸ï¸ åŠŸèƒ½æµ‹è¯• - å¾…æ‰§è¡Œï¼ˆæŒ‰ç…§æµ‹è¯•æ¸…å•ï¼‰
3. â¸ï¸ æ›´æ–°å‰©ä½™é˜¶æ®µæ–‡æ¡£ - å¾…æ‰§è¡Œ

### åç»­å·¥ä½œ
- **é˜¶æ®µ5**: AIé€‚é…å™¨å®ç°
- **é˜¶æ®µ6**: å…¨é¢æµ‹è¯•ä¸ä¿®å¤
- **æ–‡æ¡£**: æ›´æ–°æ‰€æœ‰é˜¶æ®µæ–‡æ¡£è¯´æ˜æ¶æ„å˜æ›´

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2025-11-14
**æäº¤**: `0c668c145076afca350c4faa5714fc1084cf37f6`
**ä½œè€…**: ç”¨æˆ· + Claude (Sonnet 4.5)
**çŠ¶æ€**: âœ… é‡æ„å®Œæˆï¼Œç¼–è¯‘é€šè¿‡
**ä»£ç å˜æ›´**: 3æ–‡ä»¶ï¼Œ-67è¡Œï¼ˆå‡€å‡å°‘13%ï¼‰
**ä¿ç•™ç³»ç»Ÿ**: åˆ†èº«å®ä½“ã€UIã€å¢ç›Šç³»ç»Ÿï¼ˆ100%ä¿ç•™ï¼‰
