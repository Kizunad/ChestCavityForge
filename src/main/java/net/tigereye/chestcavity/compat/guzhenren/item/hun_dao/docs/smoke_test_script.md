# Hun Dao Smoke 测试脚本

## 测试前准备

### 环境要求
- Minecraft 版本：[填写项目支持的版本]
- Mod 版本：ChestCavity + Guzhenren Compat
- 游戏模式：创造模式（便于快速获取器官）
- 难度：简单或普通（便于测试伤害转化）

### 必需物品
```
/give @s guzhenren:xiao_hun_gu    # 小魂蛊
/give @s guzhenren:da_hun_gu      # 大魂蛊
/give @s guzhenren:gui_qi_gu      # 鬼气蛊（可选）
/give @s guzhenren:ti_po_gu       # 体魄蛊（可选）
```

### 调试命令（如果可用）
```
# 查看魂魄值
/guzhenren resource get @s hunpo

# 查看最大魂魄值
/guzhenren resource get @s zuida_hunpo

# 设置魂魄值（测试用）
/guzhenren resource set @s hunpo 100

# 检查魂兽状态
/soulbeast status @s
```

---

## 测试场景 1：魂兽化仪式

### 目标
验证玩家能够成功进入魂兽状态，并初始化资源

### 准备步骤
1. 打开胸腔界面
2. 装备小魂蛊（xiao_hun_gu）
3. 装备大魂蛊（da_hun_gu）
4. 确保从未执行过魂兽化仪式（新角色或重置）

### 执行步骤
1. 关闭胸腔界面
2. 执行魂兽化命令或触发仪式流程：
   ```
   # 方式 1：通过命令（如果有）
   /hun_shou_hua start

   # 方式 2：通过游戏内机制（查看流程定义）
   # 可能需要特定的交互或物品
   ```
3. 等待仪式完成（观察进度提示）

### 验收检查表
- [x] **魂兽状态激活**：玩家获得魂兽状态（通过命令 `/soulbeast status @s` 验证）
- [x] **魂魄初始化**：当前魂魄值 = 最大魂魄值
  - 验证：`/guzhenren resource get @s hunpo` 应等于 `/guzhenren resource get @s zuida_hunpo`
- [x] **客户端反馈**：
  - 屏幕显示成功提示或特效
  - UI 更新显示魂兽状态图标
- [x] **永久标记**：无法再次执行魂兽化仪式（重复执行应被阻止）

### 预期结果
- 魂兽状态标志：`true`
- 魂魄值：填充至最大值（例如：100/100）
- 日志输出（如果启用 DEBUG）：
  ```
  [soulbeast] soul beast state changed: NORMAL -> SOUL_BEAST
  [hun_dao][middleware] adjusted 100.00 hunpo for <player> (transform)
  ```

### 失败排查
- **仪式无法启动**：
  - 检查是否装备了小魂蛊 + 大魂蛊
  - 检查是否已使用过魂兽化（查看器官 NBT 标记）
- **魂魄未初始化**：
  - 检查 `zuida_hunpo` 是否正确设置
  - 查看日志是否有错误信息

---

## 测试场景 2：魂魄生成与消耗

### 目标
验证器官的被动魂魄恢复与魂兽状态的魂魄泄露机制

### 准备步骤
1. 完成测试场景 1（进入魂兽状态）
2. 记录初始魂魄值：`/guzhenren resource get @s hunpo`

### 执行步骤（子测试 2.1：魂魄泄露）
1. 站立不动，观察 20 秒（1 个游戏内秒 = 20 ticks）
2. 每 5 秒记录一次魂魄值
3. 计算泄露速率

### 验收检查表（子测试 2.1）
- [x] **泄露速率正确**：每秒 -3.0 魂魄
  - 公式：`(初始魂魄 - 当前魂魄) / 经过秒数 ≈ 3.0`
- [x] **同时恢复**：小魂蛊 +1.0/s, 大魂蛊 +2.0/s
  - 净泄露：3.0 - 1.0 - 2.0 = 0.0/s（如果同时装备）
  - 实际测量应接近 0
- [x] **饱食维护**：
  - 饱食度维持在 18 左右
  - 饱和度有轻微增长（+0.5）

### 执行步骤（子测试 2.2：攻击消耗）
1. 记录当前魂魄值
2. 近战攻击一个生物（例如：僵尸）
3. 立即记录攻击后魂魄值

### 验收检查表（子测试 2.2）
- [x] **基础消耗**：攻击后魂魄减少 18.0
  - 公式：`攻击前魂魄 - 攻击后魂魄 = 18.0`
- [x] **大魂蛊威灵减免**（如果装备大魂蛊）：
  - 实际消耗 = 18.0 - 10.0 = 8.0
  - 验证：`攻击前魂魄 - 攻击后魂魄 = 8.0`
- [x] **魂魄不足时攻击失败**：
  - 将魂魄设置为 5.0：`/guzhenren resource set @s hunpo 5`
  - 尝试攻击，应不触发魂焰 DoT
  - 日志输出（DEBUG）：`lacks hunpo for soul flame`

### 预期结果
| 时间（秒） | 魂魄值（示例） | 说明 |
|-----------|---------------|------|
| 0 | 100.0 | 初始值 |
| 5 | 100.0 | 泄露 -15.0, 恢复 +15.0 (平衡) |
| 10 | 100.0 | 同上 |
| 攻击后 | 92.0 | 消耗 8.0 (威灵减免) |

---

## 测试场景 3：魂焰 DoT

### 目标
验证攻击触发的魂焰持续伤害机制

### 准备步骤
1. 确保处于魂兽状态且魂魄 >= 18.0
2. 生成一个测试目标（例如：`/summon zombie ~ ~ ~`）
3. 准备观察目标血量变化

### 执行步骤
1. 记录目标初始血量（僵尸通常 20 HP）
2. 近战攻击目标一次
3. 观察目标持续受到伤害（5 秒内）
4. 记录每次 DoT 触发时的伤害值

### 验收检查表
- [x] **DoT 触发**：攻击后目标持续受到伤害，每秒 1 次
- [x] **持续时间**：DoT 持续 5 秒（共 5 次伤害）
- [x] **伤害计算正确**：
  - 基础 DoT = max_hunpo × 0.01
  - 例如：max_hunpo = 100 → DoT = 1.0/秒
  - 联动加成（如果有）：DoT × (1 + 加成)
- [x] **特效与音效**：
  - 目标周围出现魂焰特效（紫色粒子或自定义效果）
  - 播放魂焰音效（`CUSTOM_SOULBEAST_DOT`）
- [x] **魂印标签**：
  - 目标附带"魂印"标签（持续 200 ticks = 10 秒）
  - 可能触发其他反应规则（如果有配置）

### 伤害验证示例
假设：
- max_hunpo = 100
- 联动加成 = 0% （无其他器官）
- 预期 DoT = 100 × 0.01 × 1.0 = 1.0/秒

| 时间（秒） | 目标 HP | 说明 |
|-----------|---------|------|
| 0 (攻击时) | 20.0 → 14.0 | 近战伤害 6.0（示例） |
| 1 | 14.0 → 13.0 | DoT -1.0 |
| 2 | 13.0 → 12.0 | DoT -1.0 |
| 3 | 12.0 → 11.0 | DoT -1.0 |
| 4 | 11.0 → 10.0 | DoT -1.0 |
| 5 | 10.0 → 9.0 | DoT -1.0 |
| 6 | 9.0 | DoT 结束 |

### 失败排查
- **DoT 未触发**：
  - 检查魂魄是否足够（需 >= 18.0 或 8.0 如果有威灵）
  - 检查攻击是否为近战（弹射物另有逻辑）
  - 查看日志：`lacks hunpo for soul flame`
- **伤害值错误**：
  - 验证 max_hunpo 值：`/guzhenren resource get @s zuida_hunpo`
  - 检查联动通道值（如果启用）

---

## 测试场景 4：伤害转化

### 目标
验证魂兽状态下受击时魂魄吸收伤害的机制

### 准备步骤
1. 确保处于魂兽状态
2. 设置魂魄值为 50.0：`/guzhenren resource set @s hunpo 50`
3. 记录当前生命值
4. 准备一个可控伤害源（例如：摔落伤害或生物攻击）

### 执行步骤（子测试 4.1：魂魄充足）
1. 记录受击前：魂魄 = 50.0, HP = 20.0（满血）
2. 受到 10.0 伤害（例如：从高处坠落）
3. 记录受击后：魂魄值和生命值

### 验收检查表（子测试 4.1）
- [x] **魂魄扣减**：魂魄减少 10.0
  - 受击后魂魄 = 50.0 - 10.0 = 40.0
- [x] **生命值不变**：HP 仍为 20.0（伤害被魂魄完全吸收）
- [x] **日志输出**（DEBUG）：
  ```
  [soulbeast] incoming damage converted: dmg=10.0 hunpoCost=10.0 drained=10.0 remainingDamage=0.0
  ```

### 执行步骤（子测试 4.2：魂魄不足）
1. 设置魂魄值为 5.0：`/guzhenren resource set @s hunpo 5`
2. 记录当前 HP（假设 20.0）
3. 受到 10.0 伤害
4. 记录受击后：魂魄值和生命值

### 验收检查表（子测试 4.2）
- [x] **魂魄耗尽**：魂魄减少至 0.0
  - 受击后魂魄 = 0.0
- [x] **剩余伤害透过**：
  - 吸收伤害 = 5.0
  - 剩余伤害 = 10.0 - 5.0 = 5.0
  - HP = 20.0 - 5.0 = 15.0
- [x] **日志输出**（DEBUG）：
  ```
  [soulbeast] incoming damage converted: dmg=10.0 hunpoCost=10.0 drained=5.0 remainingDamage=5.0
  ```

### 预期结果总表

| 场景 | 初始魂魄 | 受到伤害 | 扣减魂魄 | 剩余伤害 | 最终 HP |
|------|---------|---------|---------|---------|---------|
| 魂魄充足 | 50.0 | 10.0 | 10.0 | 0.0 | 20.0 |
| 魂魄不足 | 5.0 | 10.0 | 5.0 | 5.0 | 15.0 |
| 魂魄耗尽 | 0.0 | 10.0 | 0.0 | 10.0 | 10.0 |

### 失败排查
- **伤害未转化**：
  - 检查是否处于魂兽状态：`/soulbeast status @s`
  - 检查伤害源是否在豁免标签中
- **转化比例错误**：
  - 当前比例：1 伤害 = 1 魂魄消耗
  - 查看日志确认计算过程

---

## 测试场景 5：器官联动（可选）

### 目标
验证器官之间的联动加成机制

### 子测试 5.1：小魂蛊联动
1. 仅装备 1 个小魂蛊
2. 观察魂魄恢复速率
3. 预期：+1.0/s × (1 + 0.2) = +1.2/s

### 子测试 5.2：大魂蛊魂意加成
1. 装备小魂蛊 + 大魂蛊（退出魂兽状态，如果可能）
2. 观察大魂蛊的魂魄恢复
3. 预期：+2.0/s × (1 + 魂意加成)
   - 2 个器官 → +2.0 × (1 + 0.0075 × 2) = +2.03/s

### 子测试 5.3：体魄蛊子魂加成
1. 装备 1 个体魄蛊（非魂兽状态）
2. 观察护盾值
3. 预期：max_hunpo × 0.005 × (1 + 0.1)

---

## 验收总结

### 必须通过的核心场景
- [x] **场景 1**：魂兽化仪式成功
- [x] **场景 2**：魂魄生成与消耗正确
- [x] **场景 3**：魂焰 DoT 触发并计算正确
- [x] **场景 4**：伤害转化机制正常

### 可选场景
- [ ] **场景 5**：器官联动加成（建议测试，但不阻塞 Phase 0）

### 测试完成标准
- 所有核心场景通过，无严重逻辑错误
- 数值偏差在 ±5% 范围内（浮点计算误差可接受）
- 日志输出无错误或异常堆栈

---

## 测试报告模板

**测试日期**：____________________
**测试人员**：____________________
**游戏版本**：____________________

| 场景 | 状态 | 备注 |
|------|------|------|
| 1. 魂兽化仪式 | ✅ / ❌ | |
| 2. 魂魄生成与消耗 | ✅ / ❌ | |
| 3. 魂焰 DoT | ✅ / ❌ | |
| 4. 伤害转化 | ✅ / ❌ | |
| 5. 器官联动（可选） | ✅ / ❌ / ⏭️ | |

**发现的问题**：
1.特效与音效 无粒子特效 音效
2.大魂蛊威灵减免 装备了2个大魂蛊 + 小魂蛊 但是貌似没有看到有减免，依旧18
3.

**总体评价**：
- [ ] 通过（无阻塞问题）
- [x] 条件通过（有轻微问题，不影响重构）
- [ ] 不通过（有严重功能缺陷）

**签名**：____________________
